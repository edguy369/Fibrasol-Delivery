@{
    ViewData["Title"] = "Detalle de Orden de Entrega";
}

<style>
    .page-header {
        background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3);
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        background: linear-gradient(135deg, #3730a3 0%, #0891b2 100%);
    }
    
    .form-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }
    
    .form-control:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
    }
    
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .status-in-progress {
        background-color: #dbeafe;
        color: #1e40af;
    }
    
    .status-delivered {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .status-cancelled {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .backorder-card {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f9fafb;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #374151;
    }
    
    .info-value {
        color: #6b7280;
    }
</style>

<div class="page-header mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-2"><i class="bi bi-truck me-3"></i><span id="pageTitle">Nueva Orden de Entrega</span></h1>
            <p class="mb-0 opacity-75">Gestiona los detalles de la orden de entrega</p>
        </div>
        <a href="/constancias" class="btn btn-light btn-lg">
            <i class="bi bi-arrow-left me-2"></i>Volver a Lista
        </a>
    </div>
</div>

<div class="form-container">
    <form id="deliveryOrderForm">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="orderId" class="form-label">ID de Orden</label>
                    <input type="text" class="form-control" id="orderId" readonly>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="orderStatus" class="form-label">Estado</label>
                    <select class="form-select" id="orderStatus">
                        <option value="">Cargando estados...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="orderTotal" class="form-label">Total</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="orderTotal" step="0.01" min="0" disabled>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-4">
            <h5 class="mb-3">Comanda</h5>
            <div id="backordersContainer">
                <!-- Backorders will be loaded here -->
            </div>
            <button type="button" class="btn btn-outline-primary" onclick="addBackorder()">
                <i class="bi bi-plus-circle me-2"></i>Agregar Comanda
            </button>
        </div>
        
        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="window.location.href='/constancias'">
                Cancelar
            </button>
            <button type="button" class="btn btn-primary-custom" onclick="saveDeliveryOrder()">
                <i class="bi bi-floppy me-2"></i>Guardar Orden
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Get order ID from URL
        const pathParts = window.location.pathname.split('/');
        const orderId = pathParts[pathParts.length - 1];
        const isNewOrder = orderId === '0';
        
        // Dummy data for demonstration
        const dummyOrderData = {
            1: {
                id: 1,
                status: { id: 1, name: "Pendiente" },
                created: "2024-01-15T08:30:00",
                total: 150.75,
                backorders: [
                    { id: 1, client: "Cliente ABC", commandNumber: "CMD-001", totalWeight: 25.500 },
                    { id: 2, client: "Cliente XYZ", commandNumber: "CMD-002", totalWeight: 18.750 }
                ]
            },
            2: {
                id: 2,
                status: { id: 2, name: "En Progreso" },
                created: "2024-01-14T14:20:00",
                total: 225.50,
                backorders: [
                    { id: 3, client: "Cliente DEF", commandNumber: "CMD-003", totalWeight: 42.250 }
                ]
            }
        };
        
        $(document).ready(function() {
            loadDeliveryStatuses().then(() => {
                if (isNewOrder) {
                    setupNewOrder();
                } else {
                    loadOrderData(parseInt(orderId));
                }
            });
        });
        
        function loadDeliveryStatuses() {
            return $.ajax({
                url: '/delivery-statuses',
                type: 'GET',
                success: function(statuses) {
                    const statusSelect = $('#orderStatus');
                    statusSelect.empty();
                    
                    // Add default option
                    statusSelect.append('<option value="">Seleccione un estado</option>');
                    
                    // Add status options from database
                    statuses.forEach(function(status) {
                        statusSelect.append(`<option value="${status.id}" data-name="${status.name}">${status.name}</option>`);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading delivery statuses:', error);
                    
                    // Fallback to static options if API fails
                    const statusSelect = $('#orderStatus');
                    statusSelect.empty();
                    statusSelect.append('<option value="">Seleccione un estado</option>');
                    statusSelect.append('<option value="1" data-name="Pendiente">Pendiente</option>');
                    statusSelect.append('<option value="2" data-name="En Progreso">En Progreso</option>');
                    statusSelect.append('<option value="3" data-name="Entregado">Entregado</option>');
                    statusSelect.append('<option value="4" data-name="Cancelado">Cancelado</option>');
                    
                    // Show error message to user
                    showErrorMessage('Error al cargar los estados. Se han cargado valores por defecto.');
                }
            });
        }
        
        function setupNewOrder() {
            document.getElementById('pageTitle').textContent = 'Nueva Constancia de Entrega';
            document.getElementById('orderId').value = 'Nuevo';
            document.getElementById('orderTotal').value = '0.00';
            addBackorder(); // Add one empty backorder by default
        }
        
        function loadOrderData(id) {
            const orderData = dummyOrderData[id];
            if (orderData) {
                document.getElementById('pageTitle').textContent = 'Editar Constancia de Entrega #' + id;
                document.getElementById('orderId').value = orderData.id;
                document.getElementById('orderStatus').value = orderData.status.id;
                document.getElementById('orderTotal').value = orderData.total.toFixed(2);
                
                // Load backorders
                orderData.backorders.forEach(backorder => {
                    addBackorder(backorder);
                });
            } else {
                // Order not found, treat as new
                setupNewOrder();
            }
        }
        
        function addBackorder(data = null) {
            const backordersContainer = document.getElementById('backordersContainer');
            const backorderIndex = backordersContainer.children.length;
            
            const backorderHtml = `
                <div class="backorder-card" data-index="${backorderIndex}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Comanda ${backorderIndex + 1}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBackorder(${backorderIndex})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Cliente</label>
                            <input type="text" class="form-control backorder-client" value="${data ? data.client : ''}" placeholder="Ingrese el nombre del cliente">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">No. Commanda</label>
                            <input type="text" class="form-control backorder-command" value="${data ? data.commandNumber : ''}" placeholder="Ingrese el número de commanda">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Peso Total Toneladas</label>
                            <div class="input-group">
                                <input type="number" class="form-control backorder-weight" value="${data ? data.totalWeight.toFixed(3) : ''}" step="0.001" min="0" placeholder="0.000" onchange="updateOrderTotal()">
                                <span class="input-group-text">Ton</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            backordersContainer.insertAdjacentHTML('beforeend', backorderHtml);
            updateOrderTotal();
        }
        
        function removeBackorder(index) {
            const backorderCard = document.querySelector(`[data-index="${index}"]`);
            if (backorderCard) {
                backorderCard.remove();
                updateOrderTotal();
                // Reindex remaining backorders
                reindexBackorders();
            }
        }
        
        function reindexBackorders() {
            const backorders = document.querySelectorAll('.backorder-card');
            backorders.forEach((backorder, index) => {
                backorder.setAttribute('data-index', index);
                backorder.querySelector('h6').textContent = `Comanda ${index + 1}`;
                const removeBtn = backorder.querySelector('.btn-outline-danger');
                removeBtn.setAttribute('onclick', `removeBackorder(${index})`);
            });
        }
        
        function updateOrderTotal() {
            let totalWeight = 0;
            const backorders = document.querySelectorAll('.backorder-card');
            
            backorders.forEach(backorder => {
                const weight = parseFloat(backorder.querySelector('.backorder-weight').value) || 0;
                totalWeight += weight;
            });
            
            // For demonstration, calculate total based on weight (e.g., $100 per ton)
            const pricePerTon = 100;
            const total = totalWeight * pricePerTon;
            
            document.getElementById('orderTotal').value = total.toFixed(2);
        }
        
        function saveDeliveryOrder() {
            // Collect form data
            const statusSelect = document.getElementById('orderStatus');
            const selectedStatusOption = statusSelect.options[statusSelect.selectedIndex];
            
            const formData = {
                id: isNewOrder ? 0 : parseInt(orderId),
                statusId: parseInt(statusSelect.value),
                statusName: selectedStatusOption ? selectedStatusOption.getAttribute('data-name') : '',
                total: parseFloat(document.getElementById('orderTotal').value),
                backorders: []
            };
            
            // Collect backorders data
            const backorders = document.querySelectorAll('.backorder-card');
            backorders.forEach(backorder => {
                const client = backorder.querySelector('.backorder-client').value;
                const commandNumber = backorder.querySelector('.backorder-command').value;
                const totalWeight = parseFloat(backorder.querySelector('.backorder-weight').value) || 0;
                
                if (client && commandNumber && totalWeight > 0) {
                    formData.backorders.push({
                        client,
                        commandNumber,
                        totalWeight
                    });
                }
            });
            
            // Validate
            if (!formData.statusId || formData.backorders.length === 0) {
                alert('Por favor, complete todos los campos requeridos y agregue al menos una orden de entrega.');
                return;
            }
            
            // Show success message
            showSuccessMessage(isNewOrder ? 'Orden de entrega creada correctamente' : 'Orden de entrega actualizada correctamente');
            
            // Redirect to list after a short delay
            setTimeout(function() {
                window.location.href = '/constancias';
            }, 1500);
        }
        
        function showSuccessMessage(message) {
            // Create and show a temporary success alert
            var alertHtml = '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                           '<i class="bi bi-check-circle me-2"></i>' + message +
                           '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                           '</div>';
            
            $('.page-header').after(alertHtml);
            
            // Auto-dismiss after 3 seconds
            setTimeout(function() {
                $('.alert-success').fadeOut();
            }, 3000);
        }
        
        function showErrorMessage(message) {
            // Create and show a temporary error alert
            var alertHtml = '<div class="alert alert-warning alert-dismissible fade show" role="alert">' +
                           '<i class="bi bi-exclamation-triangle me-2"></i>' + message +
                           '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                           '</div>';
            
            $('.page-header').after(alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(function() {
                $('.alert-warning').fadeOut();
            }, 5000);
        }
    </script>
}
