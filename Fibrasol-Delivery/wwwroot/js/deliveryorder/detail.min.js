const orderId=FibrasolUtils.utils.getIdFromUrl(),isNewOrder="0"===orderId;function loadDeliveryStatuses(){return $.ajax({url:"/delivery-statuses",type:"GET",success:function(e){console.log("Delivery statuses loaded:",e);const t=$("#orderStatus");t.empty(),t.append('<option value="">Seleccione un estado</option>'),e.forEach(function(e){t.append(`<option value="${e.id}" data-name="${e.name}">${e.name}</option>`)}),isNewOrder&&e.length>0&&(t.val("1"),console.log("Default status (ID: 1) selected for new order")),console.log("Status options added to dropdown")},error:function(e,t,n){console.error("Error loading delivery statuses:",n),console.log("XHR Response:",e.responseText);const a=$("#orderStatus");a.empty(),a.append('<option value="">Seleccione un estado</option>'),a.append('<option value="1" data-name="Pendiente">Pendiente</option>'),a.append('<option value="2" data-name="En Progreso">En Progreso</option>'),a.append('<option value="3" data-name="Entregado">Entregado</option>'),a.append('<option value="4" data-name="Cancelado">Cancelado</option>'),isNewOrder&&(a.val("1"),console.log("Default status (ID: 1) selected for new order (fallback)")),FibrasolUtils.ui.showErrorMessage("Error al cargar los estados. Se han cargado valores por defecto.")}})}function setupNewOrder(){document.getElementById("pageTitle").textContent="Nueva Constancia de Entrega",document.getElementById("orderId").value="Nuevo",document.getElementById("orderTotal").value="0.00",window.originalRiders=[],window.currentRiders=[],createNewDeliveryOrder(),addBackorder()}function createNewDeliveryOrder(){$.ajax({url:"/delivery-orders",type:"POST",contentType:"application/json",data:JSON.stringify({Total:0}),success:function(e){document.getElementById("orderId").value=e,window.currentOrderId=e,document.getElementById("pageTitle").textContent="Nueva Constancia de Entrega #"+e},error:function(e,t,n){console.error("Error creating new delivery order:",n),FibrasolUtils.ui.showErrorMessage("Error al crear nueva orden de entrega. Por favor, inténtelo de nuevo.")}})}function loadOrderData(e){$.ajax({url:`/delivery-orders/${e}`,type:"GET",success:function(t){if(console.log("Order data loaded:",t),console.log("Riders in order data:",t.riders),t){document.getElementById("pageTitle").textContent="Editar Constancia de Entrega #"+e,document.getElementById("orderId").value=t.id,document.getElementById("orderTotal").value=t.total.toFixed(2);const n=document.getElementById("orderStatus");if(t.status.id&&(console.log("Setting status to:",t.status.name),n.value=t.status.id,n.value!==t.status.id)){console.warn("Status not set correctly. Available options:");for(let e of n.options)console.log(`Option value: ${e.value}, text: ${e.text}`)}window.currentOrderId=t.id,t.riders&&t.riders.length>0?(console.log("Loading riders from order data:",t.riders),window.originalRiders=t.riders.map(e=>parseInt(e.id)),window.currentRiders=[...window.originalRiders],setTimeout(()=>{const e=document.getElementById("orderRiders");e&&e.options.length>1&&(window.originalRiders.forEach(t=>{const n=e.querySelector(`option[value="${t}"]`);n&&(n.selected=!0,console.log(`Selected rider: ${n.text} (ID: ${t})`))}),updateCurrentRiders())},200)):(console.log("No riders found in order data"),window.originalRiders=[],window.currentRiders=[]),t.backorders&&t.backorders.length>0&&t.backorders.forEach(e=>{addBackorder(e)})}else setupNewOrder()},error:function(e,t,n){console.error("Error loading delivery order:",n),console.log("XHR Response:",e.responseText),setupNewOrder(),FibrasolUtils.ui.showErrorMessage("Error al cargar la orden de entrega. Se ha iniciado una nueva orden.")}})}function addBackorder(e=null){const t=document.getElementById("backordersContainer"),n=t.children.length,a=`\n        <div class="backorder-card" data-index="${n}"\n             data-backorder-id="${e&&e.id||0}"\n             data-object-status="${e?"existing":"new"}"\n             data-original-client-id="${e&&e.client?e.client.id:""}"\n             data-original-number="${e?e.number:""}"\n             data-original-weight="${e?e.weight:""}">\n            <div class="d-flex justify-content-between align-items-center mb-2">\n                <h6 class="mb-0">Comanda ${n+1}</h6>\n                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBackorder(${n})">\n                    <i class="bi bi-trash"></i>\n                </button>\n            </div>\n            <div class="row">\n                <div class="col-md-4">\n                    <label class="form-label">Cliente</label>\n                    <div class="client-search-container">\n                        <div class="input-group">\n                            <input type="text" class="form-control backorder-client" value="${e&&e.client?e.client.name:""}" placeholder="Buscar cliente..." autocomplete="off" onkeyup="searchClients(this)" onfocus="searchClients(this)" onblur="hideClientDropdown(this)" onchange="checkBackorderChanges(${n})">\n                            <button class="btn btn-outline-primary" type="button" onclick="openCreateClientModal(${n})" title="Crear nuevo cliente">\n                                <i class="bi bi-plus"></i>\n                            </button>\n                        </div>\n                        <input type="hidden" class="backorder-client-id" value="${e&&e.client?e.client.id:""}" onchange="checkBackorderChanges(${n})">\n                        <div class="client-dropdown"></div>\n                    </div>\n                </div>\n                <div class="col-md-4">\n                    <label class="form-label">No. Commanda</label>\n                    <input type="text" class="form-control backorder-command" value="${e?e.number:""}" placeholder="Ingrese el número de commanda" onchange="checkBackorderChanges(${n})">\n                </div>\n                <div class="col-md-4">\n                    <label class="form-label">Peso Total Toneladas</label>\n                    <div class="input-group">\n                        <input type="number" class="form-control backorder-weight" value="${e?e.weight.toFixed(3):""}" step="0.001" min="0" placeholder="0.000" onchange="checkBackorderChanges(${n})">\n                        <span class="input-group-text">Ton</span>\n                    </div>\n                </div>\n            </div>\n\n            <div class="factura-section">\n                <div class="d-flex justify-content-between align-items-center mb-2">\n                    <h6 class="mb-0">Facturas</h6>\n                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFactura(${n})">\n                        <i class="bi bi-plus-circle me-1"></i>Agregar Factura\n                    </button>\n                </div>\n                <div class="facturas-container" data-comanda="${n}">\n                    \x3c!-- Facturas will be added here --\x3e\n                </div>\n            </div>\n        </div>\n    `;t.insertAdjacentHTML("beforeend",a),e&&e.invoices&&e.invoices.length>0&&(console.log("Loading invoices for backorder:",n,"invoices:",e.invoices),e.invoices.forEach(e=>{console.log("Processing invoice:",e),0!=e.id&&addFactura(n,e)})),setTimeout(()=>updateOrderTotal(),100)}function removeBackorder(e){const t=document.querySelector(`[data-index="${e}"]`);if(t){const n=t.getAttribute("data-backorder-id"),a=t.getAttribute("data-object-status");if("existing"===a||"update"===a){const a=t.querySelector(".backorder-client-id").value,r=t.querySelector(".backorder-command").value,o=parseFloat(t.querySelector(".backorder-weight").value)||0,c=[];t.querySelectorAll(".factura-card").forEach((t,n)=>{const a=getFacturaData(e,n);a&&(a.objectStatus="delete",c.push(a))}),window.deletedBackorders.push({id:parseInt(n),orderId:window.currentOrderId,clientId:parseInt(a),number:r,weight:o,objectStatus:"delete",invoices:c})}t.remove(),updateOrderTotal(),reindexBackorders()}}function reindexBackorders(){document.querySelectorAll(".backorder-card").forEach((e,t)=>{e.setAttribute("data-index",t),e.querySelector("h6").textContent=`Comanda ${t+1}`;e.querySelector(".btn-outline-danger").setAttribute("onclick",`removeBackorder(${t})`);e.querySelector(".facturas-container").setAttribute("data-comanda",t);e.querySelector(".btn-outline-primary").setAttribute("onclick",`addFactura(${t})`)})}function addFactura(e,t=null){const n=document.querySelector(`[data-comanda="${e}"]`),a=n.children.length,r=`\n        <div class="factura-card" data-factura-index="${a}"\n             data-factura-id="${t&&t.id||0}"\n             data-factura-status="${t?"existing":"new"}"\n             data-original-attachment="${t&&t.attatchment||""}"\n             data-original-signed-attachment="${t&&t.signedAttatchment||""}">\n            <div class="factura-header">\n                <div class="d-flex justify-content-between align-items-center">\n                    <small class="fw-bold">Factura ${a+1}</small>\n                    <button type="button" class="btn btn-sm-custom btn-outline-danger" onclick="removeFactura(${e}, ${a})">\n                        <i class="bi bi-trash"></i>\n                    </button>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-md-4">\n                    <label class="form-label">Dirección</label>\n                    <input type="text" class="form-control factura-direccion" value="${t?t.address:""}" placeholder="Ingrese la dirección" onchange="checkFacturaChanges(${e}, ${a})">\n                </div>\n                <div class="col-md-4">\n                    <label class="form-label">Referencia</label>\n                    <input type="text" class="form-control factura-reference" value="${t?t.reference:""}" placeholder="Ingrese la referencia" onchange="checkFacturaChanges(${e}, ${a})">\n                </div>\n                <div class="col-md-4">\n                    <label class="form-label">Vendedor</label>\n                    <select class="form-control factura-salesperson" onchange="checkFacturaChanges(${e}, ${a})">\n                        <option value="">Seleccione un vendedor</option>\n                        \x3c!-- Options will be populated by JavaScript --\x3e\n                    </select>\n                </div>\n            </div>\n            <div class="row mt-2">\n                <div class="col-md-4">\n                    <label class="form-label">Valor</label>\n                    <div class="input-group">\n                        <span class="input-group-text">Q</span>\n                        <input type="number" class="form-control factura-value" value="${t?t.value.toFixed(2):""}" step="0.01" min="0" placeholder="0.00" onchange="updateOrderTotal(); checkFacturaChanges(${e}, ${a})" oninput="updateOrderTotal()">\n                    </div>\n                </div>\n                <div class="col-md-4">\n                    <label class="form-label">Factura</label>\n                    <div class="document-container">\n                        ${t&&t.attatchment?`<div class="existing-document">\n                                <a href="${t.attatchment}" target="_blank" class="btn btn-sm btn-outline-info me-2">\n                                    <i class="bi bi-file-earmark-pdf me-1"></i>Ver Documento\n                                </a>\n                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDocument(${e}, ${a}, 'attachment')">\n                                    <i class="bi bi-x"></i>\n                                </button>\n                            </div>`:`<input type="file" class="form-control factura-file" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileChange(this, ${e}, ${a}, 'attachment')">`}\n                        <input type="hidden" class="factura-attachment-base64" value="${t&&t.attatchment?t.attatchment:""}">\n                        <input type="hidden" class="factura-attachment-changed" value="false">\n                    </div>\n                </div>\n                <div class="col-md-4">\n                    <label class="form-label">Factura Firmada</label>\n                    <div class="document-container">\n                        ${t&&t.signedAttatchment?`<div class="existing-document">\n                                <a href="${t.signedAttatchment}" target="_blank" class="btn btn-sm btn-outline-info me-2">\n                                    <i class="bi bi-file-earmark-pdf me-1"></i>Ver Documento\n                                </a>\n                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDocument(${e}, ${a}, 'signed')">\n                                    <i class="bi bi-x"></i>\n                                </button>\n                            </div>`:`<input type="file" class="form-control factura-signed-file" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileChange(this, ${e}, ${a}, 'signed')">`}\n                        <input type="hidden" class="factura-signed-attachment-base64" value="${t&&t.signedAttatchment?t.signedAttatchment:""}">\n                        <input type="hidden" class="factura-signed-attachment-changed" value="false">\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;n.insertAdjacentHTML("beforeend",r);const o=n.lastElementChild.querySelector(".factura-salesperson"),c=t&&t.salesPerson?t.salesPerson.id:null;t&&t.salesPerson&&console.log(`Loading SalesPerson for invoice: ${t.salesPerson.name} (ID: ${t.salesPerson.id})`),populateSalesPersonDropdown(o,c),updateOrderTotal()}function removeFactura(e,t){const n=document.querySelector(`[data-comanda="${e}"] [data-factura-index="${t}"]`);if(n){const a=parseInt(n.getAttribute("data-factura-id"))||0,r=n.getAttribute("data-factura-status");if(("existing"===r||"update"===r)&&a>0){const n=getFacturaData(e,t);if(n){const t=document.querySelector(`[data-index="${e}"]`),a=parseInt(t.getAttribute("data-backorder-id"))||0;n.objectStatus="delete",n.backorderId=a,window.deletedInvoices.push(n),console.log("Added invoice to deleted list:",n),console.log("Backorder ID for deleted invoice:",a)}}n.remove(),reindexFacturas(e),updateOrderTotal()}}function reindexFacturas(e){document.querySelector(`[data-comanda="${e}"]`).querySelectorAll(".factura-card").forEach((t,n)=>{t.setAttribute("data-factura-index",n),t.querySelector("small").textContent=`Factura ${n+1}`;t.querySelector(".btn-outline-danger").setAttribute("onclick",`removeFactura(${e}, ${n})`)})}function updateOrderTotal(){let e=0;document.querySelectorAll(".backorder-card").forEach(t=>{t.querySelectorAll(".factura-value").forEach(t=>{const n=parseFloat(t.value)||0;e+=n})}),document.getElementById("orderTotal").value=e.toFixed(2)}function handleFileChange(e,t,n,a){const r=e.files[0];if(!r)return;const o=new FileReader;o.onload=function(e){const r=e.target.result,o=document.querySelector(`[data-comanda="${t}"] [data-factura-index="${n}"]`);if(o){const e="attachment"===a?o.querySelector(".col-md-4:nth-child(2) .document-container"):o.querySelector(".col-md-4:nth-child(3) .document-container");"attachment"===a?(o.querySelector(".factura-attachment-base64").value=r,o.querySelector(".factura-attachment-changed").value="true"):"signed"===a&&(o.querySelector(".factura-signed-attachment-base64").value=r,o.querySelector(".factura-signed-attachment-changed").value="true");const c=`\n                <div class="existing-document">\n                    <a href="${r}" target="_blank" class="btn btn-sm btn-outline-info me-2">\n                        <i class="bi bi-file-earmark-pdf me-1"></i>Ver Documento\n                    </a>\n                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDocument(${t}, ${n}, '${a}')">\n                        <i class="bi bi-x"></i>\n                    </button>\n                </div>\n            `,i=e.querySelector('input[type="file"]');i&&(i.remove(),e.insertAdjacentHTML("afterbegin",c)),checkFacturaChanges(t,n)}},o.readAsDataURL(r)}function removeDocument(e,t,n){const a=document.querySelector(`[data-comanda="${e}"] [data-factura-index="${t}"]`);if(!a)return;const r="attachment"===n?a.querySelector(".col-md-4:nth-child(2) .document-container"):a.querySelector(".col-md-4:nth-child(3) .document-container");"attachment"===n?(a.querySelector(".factura-attachment-base64").value="",a.querySelector(".factura-attachment-changed").value="true"):"signed"===n&&(a.querySelector(".factura-signed-attachment-base64").value="",a.querySelector(".factura-signed-attachment-changed").value="true");const o=r.querySelector(".existing-document");o&&o.remove();const c=`<input type="file" class="form-control ${"attachment"===n?"factura-file":"factura-signed-file"}" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileChange(this, ${e}, ${t}, '${n}')">`;r.insertAdjacentHTML("afterbegin",c),checkFacturaChanges(e,t)}function checkFacturaChanges(e,t){const n=document.querySelector(`[data-comanda="${e}"] [data-factura-index="${t}"]`);if(!n)return;const a=n.getAttribute("data-factura-status");if("new"===a)return;n.querySelector(".factura-direccion").value,n.querySelector(".factura-reference").value,parseFloat(n.querySelector(".factura-value").value),parseInt(n.querySelector(".factura-salesperson").value);const r="true"===n.querySelector(".factura-attachment-changed").value,o="true"===n.querySelector(".factura-signed-attachment-changed").value,c=r||o;c&&"existing"===a?n.setAttribute("data-factura-status","update"):c||"update"!==a||n.setAttribute("data-factura-status","existing")}function getFacturaData(e,t){const n=document.querySelector(`[data-comanda="${e}"] [data-factura-index="${t}"]`);if(!n)return null;const a=parseInt(n.getAttribute("data-factura-id"))||0,r=n.querySelector(".factura-direccion").value,o=n.querySelector(".factura-reference").value,c=parseFloat(n.querySelector(".factura-value").value)||0,i=parseInt(n.querySelector(".factura-salesperson").value)||0,d=n.querySelector(".factura-attachment-base64").value,s=n.querySelector(".factura-signed-attachment-base64").value,l="true"===n.querySelector(".factura-attachment-changed").value,u="true"===n.querySelector(".factura-signed-attachment-changed").value;return{id:a,backorderId:0,address:r,reference:o,value:c,salesPersonId:i,attatchment:d,signedAttatchment:s,objectStatus:n.getAttribute("data-factura-status"),attatchmentChanged:l,signedAttatchmentChanged:u}}function checkBackorderChanges(e){const t=document.querySelector(`[data-index="${e}"]`);if(!t)return;const n=t.getAttribute("data-object-status");if("new"===n)return;const a=t.querySelector(".backorder-client-id").value,r=t.querySelector(".backorder-command").value,o=parseFloat(t.querySelector(".backorder-weight").value)||0,c=t.getAttribute("data-original-client-id"),i=t.getAttribute("data-original-number"),d=parseFloat(t.getAttribute("data-original-weight"))||0,s=a!==c||r!==i||Math.abs(o-d)>.001;s&&"existing"===n?t.setAttribute("data-object-status","update"):s||"update"!==n||t.setAttribute("data-object-status","existing")}window.currentOrderId=isNewOrder?null:parseInt(orderId),window.deletedBackorders=[],window.deletedInvoices=[],window.originalBackorders=[],window.originalRiders=[],window.currentRiders=[],window.salesPersons=[],$(document).ready(function(){loadSalesPersons(),Promise.all([loadDeliveryStatuses(),loadClients(),loadRiders()]).then(()=>{isNewOrder?setupNewOrder():loadOrderData(parseInt(orderId))})});let searchTimeout,clientsData=[];function loadClients(){return $.ajax({url:"/clients",type:"GET",success:function(e){clientsData=e},error:function(e,t,n){console.error("Error loading clients:",n),clientsData=[]}})}function loadRiders(){return $.ajax({url:"/riders",type:"GET",success:function(e){console.log("Riders loaded:",e);const t=$("#orderRiders");t.empty(),e.forEach(function(e){t.append(`<option value="${e.id}">${e.name}</option>`)}),console.log("Rider options added to dropdown"),t.off("change.riderTracking").on("change.riderTracking",function(){updateCurrentRiders()})},error:function(e,t,n){console.error("Error loading riders:",n),console.log("XHR Response:",e.responseText);const a=$("#orderRiders");a.empty(),a.append('<option value="">Error cargando mensajeros</option>'),FibrasolUtils.ui.showErrorMessage("Error al cargar los mensajeros.")}})}function updateCurrentRiders(){const e=document.getElementById("orderRiders");window.currentRiders=Array.from(e.selectedOptions).map(e=>parseInt(e.value)),console.log("Current riders updated:",window.currentRiders),updateRidersCounter()}function updateRidersCounter(){const e=document.getElementById("ridersSelectedCount"),t=document.getElementById("ridersCount");window.currentRiders.length>0?(t.textContent=window.currentRiders.length,e.style.display="block"):e.style.display="none"}function getRidersData(){const e=[];return window.currentRiders.forEach(t=>{window.originalRiders.includes(t)||e.push({riderId:t,objectState:"new"})}),window.originalRiders.forEach(t=>{window.currentRiders.includes(t)&&e.push({riderId:t,objectState:"existing"})}),window.originalRiders.forEach(t=>{window.currentRiders.includes(t)||e.push({riderId:t,objectState:"delete"})}),console.log("Riders data generated:",e),e}function searchClients(e){clearTimeout(searchTimeout),searchTimeout=setTimeout(()=>{const t=e.value.toLowerCase().trim(),n=e.parentElement.querySelector(".client-dropdown");if(0===t.length)return void showAllClients(n);showClientDropdown(n,clientsData.filter(e=>e.name.toLowerCase().includes(t)),e)},300)}function showAllClients(e){showClientDropdown(e,clientsData.slice(0,10),null)}function showClientDropdown(e,t,n){e.innerHTML="",0===t.length?e.innerHTML='<div class="client-dropdown-item">No se encontraron clientes</div>':t.forEach(t=>{const a=document.createElement("div");a.className="client-dropdown-item",a.textContent=t.name,a.setAttribute("data-client-id",t.id),a.addEventListener("mousedown",function(a){a.preventDefault(),selectClient(n||e.parentElement.querySelector(".backorder-client"),t)}),e.appendChild(a)}),e.style.display="block"}function selectClient(e,t){const n=e.parentElement,a=n.querySelector(".backorder-client-id"),r=n.querySelector(".client-dropdown");e.value=t.name,a.value=t.id,r.style.display="none";const o=e.closest(".backorder-card");if(o){checkBackorderChanges(parseInt(o.getAttribute("data-index")))}}function hideClientDropdown(e){setTimeout(()=>{e.parentElement.querySelector(".client-dropdown").style.display="none"},200)}function saveDeliveryOrder(){const e=window.currentOrderId||parseInt(orderId);if(!e)return void FibrasolUtils.ui.showErrorMessage("No se ha establecido un ID de orden válido. Por favor, recargue la página.");const t=document.getElementById("orderStatus"),n=(t.options[t.selectedIndex],{total:parseFloat(document.getElementById("orderTotal").value),statusId:parseInt(t.value),riders:getRidersData(),backOrders:[]});if(document.querySelectorAll(".backorder-card").forEach((t,a)=>{const r=parseInt(t.getAttribute("data-backorder-id"))||0,o=parseInt(t.querySelector(".backorder-client-id").value),c=t.querySelector(".backorder-command").value,i=parseFloat(t.querySelector(".backorder-weight").value)||0,d=t.getAttribute("data-object-status");if(o&&c&&i>0){const s=[];t.querySelectorAll(".factura-card").forEach((e,t)=>{const n=getFacturaData(a,t);n&&(n.backorderId=r,s.push(n))}),console.log("Processing backorder ID:",r,"Deleted invoices:",window.deletedInvoices),window.deletedInvoices.forEach(e=>{console.log("Checking deleted invoice backorderId:",e.backorderId,"against current backorderId:",r),e.backorderId===r&&(console.log("Adding deleted invoice to backorder:",e),s.push(e))}),n.backOrders.push({id:r,orderId:e,clientId:o,number:c,weight:i,objectStatus:d,invoices:s})}}),window.deletedBackorders.forEach(e=>{n.backOrders.push(e)}),!t.value||0===n.backOrders.length)return void alert("Por favor, complete todos los campos requeridos y agregue al menos una orden de entrega.");const a=document.querySelector(".btn-primary-custom");FibrasolUtils.ui.setButtonLoading(a),console.log("Final form data being sent to backend:",JSON.stringify(n,null,2)),$.ajax({url:`/delivery-orders/${e}`,type:"PUT",contentType:"application/json",data:JSON.stringify(n),success:function(e){FibrasolUtils.ui.showSuccessMessage("Constancia de entrega guardada correctamente"),setTimeout(function(){window.location.href="/constancias"},1500)},error:function(e,t,n){console.error("Error saving delivery order:",n),FibrasolUtils.ui.showErrorMessage("Error al guardar la constancia de entrega. Por favor, inténtelo de nuevo.")},complete:function(){FibrasolUtils.ui.setButtonLoading(a,!1)}})}function loadSalesPersons(){$.ajax({url:"/sales-persons",type:"GET",success:function(e){window.salesPersons=e,console.log("SalesPersons loaded:",e)},error:function(e,t,n){console.error("Error loading SalesPersons:",n)}})}function populateSalesPersonDropdown(e,t=null){e.innerHTML='<option value="">Seleccione un vendedor</option>',window.salesPersons.forEach(n=>{const a=document.createElement("option");a.value=n.id,a.textContent=n.name,t&&n.id===t&&(a.selected=!0),e.appendChild(a)})}function openCreateClientModal(e){window.currentBackorderIndex=e,document.getElementById("newClientName").value="",document.getElementById("newClientName").classList.remove("is-invalid");const t=document.querySelector("#createClientModal .btn-primary-custom");t.querySelector(".btn-text").classList.remove("d-none"),t.querySelector(".btn-spinner").classList.add("d-none"),t.disabled=!1;new bootstrap.Modal(document.getElementById("createClientModal")).show()}function createNewClient(){const e=document.getElementById("newClientName").value.trim(),t=document.getElementById("newClientName");if(!e)return void t.classList.add("is-invalid");t.classList.remove("is-invalid");const n=document.querySelector("#createClientModal .btn-primary-custom");n.querySelector(".btn-text").classList.add("d-none"),n.querySelector(".btn-spinner").classList.remove("d-none"),n.disabled=!0,$.ajax({url:"/clients",type:"POST",contentType:"application/json",data:JSON.stringify({Name:e}),success:function(t){console.log("Client created successfully with ID:",t);const n={id:t,name:e};if(window.clients||(window.clients=[]),window.clients.push(n),null!==window.currentBackorderIndex){const n=document.querySelector(`[data-index="${window.currentBackorderIndex}"]`);if(n){const a=n.querySelector(".backorder-client"),r=n.querySelector(".backorder-client-id");a.value=e,r.value=t,r.dispatchEvent(new Event("change"))}}FibrasolUtils.ui.hideModal("createClientModal"),FibrasolUtils.ui.showSuccessMessage(`Cliente "${e}" creado exitosamente`)},error:function(e,t,n){console.error("Error creating client:",n),FibrasolUtils.ui.showErrorMessage("Error al crear el cliente. Por favor, inténtelo de nuevo.")},complete:function(){n.querySelector(".btn-text").classList.remove("d-none"),n.querySelector(".btn-spinner").classList.add("d-none"),n.disabled=!1}})}window.currentBackorderIndex=null,document.addEventListener("DOMContentLoaded",function(){document.getElementById("newClientName").addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),createNewClient())})});