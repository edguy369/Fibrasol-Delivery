document.addEventListener("DOMContentLoaded",function(){loadDashboardData(),loadUnsignedOrders(),updateTimestamp()});async function loadDashboardData(){try{const[e,t,n,s,a]=await Promise.all([FibrasolUtils.api.get("/dashboards/riders"),FibrasolUtils.api.get("/dashboards/clients"),FibrasolUtils.api.get("/dashboards/sales-persons"),FibrasolUtils.api.get("/dashboards/delivery-orders"),FibrasolUtils.api.get("/dashboards/invoices")]);FibrasolUtils.ui.updateCounter("driversCount",e),FibrasolUtils.ui.updateCounter("clientsCount",t),FibrasolUtils.ui.updateCounter("salesPersonsCount",n),FibrasolUtils.ui.updateCounter("ordersCount",s),updateInvoicesCounter(a)}catch(e){console.error("Error loading dashboard data:",e),showErrorState()}}function updateInvoicesCounter(e){const t=e.invoices||0,n=e.signedInvoices||0;FibrasolUtils.ui.updateCounter("invoicesCount",t);const s=document.getElementById("invoicesProgress"),a=document.getElementById("invoicesText");s&&a&&setTimeout(()=>{s.style.width=`${t>0?n/t*100:0}%`,a.textContent=`${n.toLocaleString("es-GT")}/${t.toLocaleString("es-GT")} firmadas`},300)}function showErrorState(){["driversCount","clientsCount","salesPersonsCount","ordersCount","invoicesCount"].forEach(e=>{const t=document.getElementById(e);t&&(t.innerHTML='<span class="error-message">Error al cargar</span>')});const e=document.getElementById("invoicesText");e&&(e.innerHTML='<span class="error-message">Error</span>')}function updateTimestamp(){const e=new Date,t=e.toLocaleString("es-GT",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),n=document.getElementById("lastUpdate");n&&(n.textContent=t)}setInterval(function(){loadDashboardData(),updateTimestamp()},3e5);let unsignedOrdersTable=null;async function loadUnsignedOrders(){try{const e=await FibrasolUtils.api.get("/dashboards/unsigned-orders");initUnsignedOrdersTable(e)}catch(e){console.error("Error loading unsigned orders:",e)}}function initUnsignedOrdersTable(e){if(unsignedOrdersTable)return unsignedOrdersTable.clear(),unsignedOrdersTable.rows.add(e),void unsignedOrdersTable.draw();unsignedOrdersTable=$("#unsignedOrdersTable").DataTable({data:e,columns:[{data:"id"},{data:"concept",width:"200px",className:"itinerario-column",render:function(e){var t=e||"-";return'<span class="itinerario-text" title="'+t+'">'+t+"</span>"}},{data:"status",render:function(e){return e?`<span class="badge bg-info">${e.name}</span>`:"-"}},{data:"created",render:function(e){return FibrasolUtils.dates.formatDateTime(e)}},{data:null,render:function(e){return FibrasolUtils.currency.formatWithSymbol(e.total,e.currency||"Q")}},{data:"id",render:function(e){return`<a href="/constancias/${e}" class="btn btn-sm btn-primary" title="Ver detalle"><i class="bi bi-eye"></i></a>`}}],language:{url:"/lib/datatables/i18n/es-ES.json"},order:[[3,"desc"]],responsive:!0})}