let salesChart=null,salesDataTable=null,currentReportData=[];function initializePage(){const e=FibrasolUtils.dates.getFirstDayOfMonth(),t=FibrasolUtils.dates.getLastDayOfMonth();document.getElementById("startDate").value=FibrasolUtils.dates.toInputFormat(e),document.getElementById("endDate").value=FibrasolUtils.dates.toInputFormat(t),salesDataTable=$("#salesTable").DataTable({...FibrasolUtils.datatables.getSpanishConfig(),order:[[0,"asc"]],columnDefs:[{targets:[2],render:function(e,t,a){return"display"===t?FibrasolUtils.currency.format(e):e}},{targets:[3],render:function(e,t,a){return"display"===t?e+"%":e}},{targets:[4],render:function(e,t,a){if("display"===t){const t=parseFloat(e);let a="bg-secondary",n="bi-dash";return t>20?(a="bg-success",n="bi-arrow-up"):t>10?(a="bg-warning",n="bi-arrow-right"):t>0&&(a="bg-info",n="bi-arrow-down-right"),`<span class="badge ${a}"><i class="bi ${n} me-1"></i>${t}%</span>`}return e}}]})}function applyQuickPeriod(){const e=document.getElementById("quickPeriod").value,t=new Date;let a,n;switch(e){case"thisMonth":a=FibrasolUtils.dates.getFirstDayOfMonth(),n=FibrasolUtils.dates.getLastDayOfMonth();break;case"lastMonth":a=new Date(t.getFullYear(),t.getMonth()-1,1),n=new Date(t.getFullYear(),t.getMonth(),0);break;case"thisQuarter":const e=Math.floor(t.getMonth()/3);a=new Date(t.getFullYear(),3*e,1),n=new Date(t.getFullYear(),3*e+3,0);break;case"thisYear":a=new Date(t.getFullYear(),0,1),n=new Date(t.getFullYear(),11,31);break;case"lastYear":a=new Date(t.getFullYear()-1,0,1),n=new Date(t.getFullYear()-1,11,31);break;default:return}document.getElementById("startDate").value=FibrasolUtils.dates.toInputFormat(a),document.getElementById("endDate").value=FibrasolUtils.dates.toInputFormat(n)}function generateReport(){const e=document.getElementById("startDate").value,t=document.getElementById("endDate").value;if(!e||!t)return void alert("Por favor, seleccione las fechas de inicio y fin.");if(new Date(e)>new Date(t))return void alert("La fecha de inicio no puede ser mayor que la fecha de fin.");showLoading();const a=FibrasolUtils.dates.formatDate(e),n=FibrasolUtils.dates.formatDate(t);document.getElementById("reportPeriod").textContent=`${a} - ${n}`;const o={startDate:e,endDate:t};$.ajax({url:"/sales-persons/report",type:"POST",contentType:"application/json",data:JSON.stringify(o),success:function(e){currentReportData=e,updateStatistics(e),updateChart(e),updateDataTable(e),hideLoading()},error:function(e,t,a){console.error("Error generating report:",a),alert("Error al generar el reporte. Por favor, intÃ©ntelo de nuevo."),hideLoading()}})}function updateStatistics(e){const t=e.reduce((e,t)=>e+t.totalSales,0),a=e.length>0?t/e.length:0,n=e.length>0?e[0].salesPerson.name:"-",o=e.length;document.getElementById("totalSales").textContent=FibrasolUtils.currency.format(t),document.getElementById("avgSales").textContent=FibrasolUtils.currency.format(a),document.getElementById("topSeller").textContent=n,document.getElementById("totalSellers").textContent=o}function updateChart(e){const t=document.getElementById("salesChart").getContext("2d");salesChart&&salesChart.destroy();const a=e.map(e=>e.salesPerson.name),n=e.map(e=>e.totalSales),o=e.map((e,t)=>`hsla(${137.5*t%360}, 70%, 60%, 0.8)`),r=o.map(e=>e.replace("0.8","1"));salesChart=new Chart(t,{type:"bar",data:{labels:a,datasets:[{label:"Ventas Totales",data:n,backgroundColor:o,borderColor:r,borderWidth:2,borderRadius:8,borderSkipped:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Ventas por Vendedor",font:{size:16,weight:"bold"},padding:20},legend:{display:!1},tooltip:{callbacks:{label:function(e){return"Ventas: "+FibrasolUtils.currency.format(e.parsed.y)}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"Q "+e.toLocaleString("es-GT")}},grid:{color:"rgba(0, 0, 0, 0.1)"}},x:{grid:{display:!1},ticks:{maxRotation:45,minRotation:0}}},animation:{duration:1e3,easing:"easeInOutQuart"}}})}function updateDataTable(e){const t=e.reduce((e,t)=>e+t.totalSales,0),a=e.map((e,a)=>{const n=t>0?(e.totalSales/t*100).toFixed(1):0;return[a+1,e.salesPerson.name,e.totalSales,n,n]});salesDataTable.clear(),salesDataTable.rows.add(a),salesDataTable.draw()}function showLoading(){document.getElementById("chartLoading").style.display="flex"}function hideLoading(){document.getElementById("chartLoading").style.display="none"}function refreshReport(){generateReport()}function exportReport(){const e=document.getElementById("startDate").value,t=document.getElementById("endDate").value;let a="data:text/csv;charset=utf-8,";a+="Reporte de Ventas - "+e+" a "+t+"\n\n",a+="Ranking,Vendedor,Total Ventas,Porcentaje\n",currentReportData.forEach((e,t)=>{const n=currentReportData.reduce((e,t)=>e+t.totalSales,0),o=n>0?(e.totalSales/n*100).toFixed(1):0;a+=`${t+1},${e.salesPerson.name},${e.totalSales},${o}%\n`});const n=encodeURI(a),o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",`reporte-ventas-${e}-${t}.csv`),document.body.appendChild(o),o.click(),document.body.removeChild(o)}$(document).ready(function(){initializePage(),generateReport()});